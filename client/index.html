<!doctype html><html><head><meta charset="utf-8"><title>商品列表</title></head>
<body>
<div id="topnav" style="background:#f5f5f5;padding:8px;border-bottom:1px solid #ddd;">
  <a href="/">登录</a>
  <a href="/index.html" data-protect="auth" style="margin-left:12px">商品列表</a>
  <a href="/cart.html" data-protect="auth" style="margin-left:12px">购物车</a>
  <a id="ordersLink" href="/orders.html" data-protect="auth" style="margin-left:12px;display:none">我的订单</a>
  <a id="adminLink" href="/admin/products.html" style="margin-left:12px;display:none">商品管理</a>
  <a id="adminOrdersLink" href="/admin/orders.html" style="margin-left:12px;display:none">订单管理</a>
  <a id="adminSalesLink" href="/admin/sales.html" style="margin-left:12px;display:none">销售报表</a>
  <a id="logoutLink" href="#" onclick="logout();return false;" style="margin-left:12px;display:none">注销</a>
  </div>
<script src="/js/common.js"></script>
<script>
try{
  const isAdmin = (localStorage.getItem('isAdmin') === 'true' || localStorage.getItem('isAdmin') === '1');
  if (isAdmin) {
    const top = document.getElementById('topnav');
    top.innerHTML = `
      <a href="/">登录</a>
      <a id="adminLink" href="/admin/products.html" style="margin-left:12px">商品管理</a>
      <a id="adminOrdersLink" href="/admin/orders.html" style="margin-left:12px">订单管理</a>
      <a id="adminSalesLink" href="/admin/sales.html" style="margin-left:12px">销售报表</a>
      <a id="logoutLink" href="#" onclick="logout();return false;" style="margin-left:12px">注销</a>
    `;
    document.getElementById('logoutLink').addEventListener('click', (e)=>{ e.preventDefault(); try{ localStorage.clear(); sessionStorage.clear(); }catch(err){}; location.href = '/'; });
  } else {
    if (localStorage.getItem('token')) {
      document.getElementById('logoutLink').style.display = 'inline';
      const o = document.getElementById('ordersLink'); if (o) o.style.display = 'inline';
    }
    document.querySelectorAll('a[data-protect="auth"]').forEach(a=>{
      a.addEventListener('click', (e)=>{ try{ if (!localStorage.getItem('token')) { e.preventDefault(); alert('请先登录'); } }catch(err){} });
    });
  }
}catch(e){};
</script>

<h2>商品列表</h2>
<div style="margin:8px 0"><input id="search" placeholder="搜索商品（按名称）" style="width:240px;padding:6px"/></div>
<div id="list"></div>
<script>
let searchTimer;
async function load(q = '') {
  const url = '/api/products' + (q ? '?q=' + encodeURIComponent(q) : '');
  const r = await fetch(url);
  const arr = await r.json();
  document.getElementById('list').innerHTML = arr.map(p => `
    <div>${p.name} ￥${p.price} 库存${p.stock}
      <button onclick="add(${p.id})">加购物车</button>
    </div>`).join('');
}

document.getElementById('search').addEventListener('input', (e) => {
  const q = e.target.value.trim();
  clearTimeout(searchTimer);
  searchTimer = setTimeout(() => load(q), 300);
});

load();

async function add(id) {
  const token = localStorage.getItem('token');
  if (!token) return alert('请先登录');
  await fetch('/api/cart', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ productId: id, quantity: 1 })
  });
  alert('已加入购物车');
}
</script>
</body></html>